# Docker Compose orchestration for The Graph Dashboards
#
# This file orchestrates:
#   - Caddy: Web server with automatic HTTPS
#   - Grumpy Goose: Production + Staging environments
#   - Rewards Eligibility Oracle: One-shot generator + scheduler
#   - Auth Gate: OTP authentication service for REO dashboard
#
# Environments:
#   - Production: hub.thegraph.foundation/goose (volumes: goose-prod-*)
#   - Staging: staging.hub.thegraph.foundation (volumes: goose-staging-*)
#
# Usage:
#   docker compose up -d                    # Start all services
#   docker compose up -d grumpygoose-staging # Start only staging
#   docker compose up -d --scale reo-scheduler=0  # Start without REO scheduler
#   docker compose logs -f                  # View all logs
#   docker compose down                     # Stop all services

version: '3.8'

services:
  # ========================================
  # CADDY - Web server with automatic HTTPS
  # ========================================
  caddy:
    image: caddy:latest
    container_name: dashboards-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3
    volumes:
      - ./infrastructure/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./infrastructure/nginx/hub:/usr/share/nginx/html/hub:ro
      - goose-prod-output:/usr/share/nginx/html/goose:ro
      - reo-output:/usr/share/nginx/html/reo:ro
      - caddy_data:/data
      - caddy_config:/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2019/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - dashboards-network

  # ========================================
  # GRUMPY GOOSE - PRODUCTION
  # ========================================
  grumpygoose:
    container_name: grumpygoose-prod
    image: ghcr.io/graphprotocol/grumpygoose:latest
    restart: "no"  # One-shot: generate and exit
    environment:
      - ENVIRONMENT=production
      - GOOSE_OUTPUT_DIR=/app/output
      - GOOSE_DATABASE_PATH=/app/data/goose.db
    volumes:
      - goose-prod-output:/app/output
      - goose-prod-data:/app/data
    command: >
      sh -c "
      echo 'ðŸª¿ Generating initial Grumpy Goose dashboard (PRODUCTION)...' &&
      python setup.py &&
      python generate_static.py &&
      echo 'âœ… Grumpy Goose dashboard generated!'
      "
    networks:
      - dashboards-network

  grumpygoose-scheduler:
    container_name: grumpygoose-scheduler-prod
    image: ghcr.io/graphprotocol/grumpygoose:latest
    restart: unless-stopped
    environment:
      - ENVIRONMENT=production
      - GOOSE_OUTPUT_DIR=/app/output
      - GOOSE_DATABASE_PATH=/app/data/goose.db
    volumes:
      - goose-prod-output:/app/output
      - goose-prod-data:/app/data
    env_file:
      - ../grumpygoose/.env
    command: ["python", "scheduler.py"]
    depends_on:
      grumpygoose:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f scheduler.py || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
    networks:
      - dashboards-network

  # ========================================
  # GRUMPY GOOSE - STAGING
  # ========================================
  grumpygoose-staging:
    container_name: grumpygoose-staging
    image: ghcr.io/graphprotocol/grumpygoose:latest
    restart: unless-stopped
    environment:
      - ENVIRONMENT=staging
      - GOOSE_OUTPUT_DIR=/app/output
      - GOOSE_DATABASE_PATH=/app/data/goose.db
    volumes:
      - goose-staging-output:/app/output
      - goose-staging-data:/app/data
    command: ["python", "server.py", "8080"]
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - dashboards-network

  grumpygoose-scheduler-staging:
    container_name: grumpygoose-scheduler-staging
    image: ghcr.io/graphprotocol/grumpygoose:latest
    restart: unless-stopped
    environment:
      - ENVIRONMENT=staging
      - GOOSE_OUTPUT_DIR=/app/output
      - GOOSE_DATABASE_PATH=/app/data/goose.db
    volumes:
      - goose-staging-output:/app/output
      - goose-staging-data:/app/data
    env_file:
      - ../grumpygoose/.env
    command: ["python", "scheduler.py"]
    depends_on:
      grumpygoose-staging:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f scheduler.py || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
    networks:
      - dashboards-network

  # ========================================
  # REWARDS ELIGIBILITY ORACLE
  # ========================================
  reo:
    container_name: reo-prod
    image: ghcr.io/graphprotocol/rewards-eligibility-oracle-dashboard:latest
    restart: "no"  # One-shot: generate and exit
    environment:
      - ENVIRONMENT=production
    volumes:
      - reo-output:/app/output
      - ../rewards-eligibility-oracle-dashboard/.env:/app/.env:ro
    command: ["python", "generate_dashboard.py"]
    networks:
      - dashboards-network

  reo-scheduler:
    container_name: reo-scheduler-prod
    image: ghcr.io/graphprotocol/rewards-eligibility-oracle-dashboard:latest
    restart: unless-stopped
    environment:
      - ENVIRONMENT=production
      - REO_SCHEDULER_INTERVAL_MINUTES=5
    volumes:
      - reo-output:/app/output
      - ../rewards-eligibility-oracle-dashboard/.env:/app/.env:ro
    command: ["python", "scheduler.py"]
    depends_on:
      reo:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f scheduler.py || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
    networks:
      - dashboards-network

  # ========================================
  # AUTH GATE - OTP Authentication Service
  # ========================================
  auth-gate:
    build:
      context: .
      dockerfile: infrastructure/auth/Dockerfile
    image: reo-auth-gate:latest
    container_name: reo-auth-gate
    restart: unless-stopped
    environment:
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM=${SMTP_FROM}
      - SESSION_SECRET=${SESSION_SECRET}
      - ALLOWED_EMAILS=${ALLOWED_EMAILS}
      - OTP_EXPIRY_MINUTES=${OTP_EXPIRY_MINUTES:-10}
      - SESSION_EXPIRY_DAYS=${SESSION_EXPIRY_DAYS:-7}
      - RATE_LIMIT_PER_HOUR=${RATE_LIMIT_PER_HOUR:-5}
    volumes:
      # Whitelist file (optional - can use ALLOWED_EMAILS env var instead)
      - ./config/allowed_emails.txt:/app/config/allowed_emails.txt:ro
      # Email templates
      - ./infrastructure/auth/templates:/app/templates:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - dashboards-network

# ========================================
# Networks
# ========================================
networks:
  dashboards-network:
    driver: bridge
    name: dashboards-network

# ========================================
# Volumes
# ========================================
volumes:
  # Production volumes
  goose-prod-output:
    driver: local
    name: goose-prod-output

  goose-prod-data:
    driver: local
    name: goose-prod-data

  # Staging volumes
  goose-staging-output:
    driver: local
    name: goose-staging-output

  goose-staging-data:
    driver: local
    name: goose-staging-data

  # REO volumes
  reo-output:
    driver: local
    name: reo-output

  # Caddy volumes
  caddy_data:
    driver: local
    name: caddy_data

  caddy_config:
    driver: local
    name: caddy_config
